{include file="base/header_new" /}
	<script>
    	var captcha_url = "{:captcha_src()}";
	</script>
	<div class="container" style="height:120px;">
		<div class="index_header" style="margin-left:0px;color:#a7adf7;">
			<div style="float:left;margin-top:45px;"><a href="/"><img src="/static/common/img//logo.png" title="FA財"></a></div>
			<ul>
				<li><a href="/home/member/index" title="个人中心"><img src="/static/common/img/member_icon.png" title="个人中心"></a></li>
				<li><a href='{:url("IndustryReport/lists")}' title="研报中心">研报中心</a></li>
				<li><a href='{:url("News/lists")}' title="资讯中心">资讯中心</a></li>
				<li><a href='{:url("Index/listorganize")}' title="找资金">找资金</a></li>
				<li><a href='{:url("Index/listproject")}' title="找项目">找项目</a></li>
				<li><a href="/" title="首页">首页</a></li>
			</ul>
		</div>
	</div>
	<div class="container" style="height:1000px;">
		<form action="/home/member/editUser" method="post" id="editUserModal">
			<div class="member_body" style="height:884px;width:1200px;">
				<ul>
					<li style="margin:30px 0 22px 0px;color:#222222;line-height:22px;height:22px;font-weight:bold;font-size:22px;">编辑信息</li>
					<li style="height:1px;"><div style="border-top:solid 1px #f3f3f3;margin-right:60px;"></div></li>
					<li style="height:124px;">
				    	<div id="user_upload" style="width:124px;height:124px;border-radius:62px;margin-left:460px;background: url('{$info.userPhoto}') center center no-repeat;">
				    		<div class="member_photo" onclick="editImg()" title="修改头像"></div>
				    		<input id="compressFile" name="file" accept="image/*" type="file" style="display: none">
				    	</div>
				    	<div class="submit_error" id="userPhoto_error" style="float:left;margin-left:10px;width:300px;">
							<div style="float:left;text-align:center;line-height:48px;"><img src="/static/common/img/error_icon.png" width="20" height="20"></div>
							<div style="float:left;" id="userPhoto_msg">&nbsp;必填项</div>
						</div>
					</li>
					<li>
						<span>&nbsp;&nbsp;&nbsp;&nbsp;真实姓名：</span>
						<div class="member_body_input" style="width:400px;"><input type="text" name="realName" id="realName" value="{$info.realName}" placeholder="真实姓名"/></div>
						<div class="submit_error" id="realName_error" style="float:left;margin-left:10px;">
							<div style="float:left;text-align:center;line-height:48px;"><img src="/static/common/img/error_icon.png" width="20" height="20"></div>
							<div style="float:left;">&nbsp;必填项</div>
						</div>
					</li>
					<li>
						<span>&nbsp;&nbsp;&nbsp;&nbsp;手机号码：</span>
						<div class="member_body_input" style="width:400px;"><input onkeyup="keyup()" type="text" name="userPhone" id="userPhone" value="{$info.userPhone}" placeholder="手机号码"/></div>
						<div id="sendCode" class="verify_code_btn" style="display:none;" onclick="getVerifyCode()">获取验证码</div>
						<div class="submit_error" id="userPhone_error" style="float:left;margin-left:10px;width:300px;">
							<div style="float:left;text-align:center;line-height:48px;"><img src="/static/common/img/error_icon.png" width="20" height="20"></div>
							<div style="float:left;" id="userPhone_msg">&nbsp;必填项</div>
						</div>
					</li>
					<li id="imgage_code" style="display:none;">
						<span>图形验证码：</span>
						<div class="member_body_input" style="width:400px;">
						<input type="text" name="imgcode" id="imgcode" placeholder="图形验证码"  width="85" maxlength="6" /></div>
						<div id="" class="" onclick="javascript:document.getElementById('codeimage').src=captcha_url+'?v=' + Math.random();"  style="float:left;margin-left:10px;cursor:pointer;">
							<div class="code">
			                    <div class="code-img">
			                        <img src="{:captcha_src()}" name="codeimage" id="codeimage" border="0">
			                    </div>
			                </div>
						</div>
						<div class="submit_error" id="imgcode_error" style="float:left;margin-left:10px;width:300px;">
							<div style="float:left;text-align:center;line-height:48px;"><img src="/static/common/img/error_icon.png" width="20" height="20"></div>
							<div style="float:left;" id="regcode_msg">&nbsp;必填项</div>
						</div>
					</li>
					<li id="verifycode" style="display:none;">
						<span>手机验证码：</span>
						<div class="member_body_input" style="width:400px;"><input type="text" name="regcode" id="regcode" placeholder="手机验证码"  width="20" maxlength="6" /></div>
						<div class="submit_error" id="regcode_error" style="float:left;margin-left:10px;width:300px;">
							<div style="float:left;text-align:center;line-height:48px;"><img src="/static/common/img/error_icon.png" width="20" height="20"></div>
							<div style="float:left;" id="regcode_msg">&nbsp;必填项</div>
						</div>
					</li>
					<li>
						<span>&nbsp;&nbsp;&nbsp;&nbsp;公司简称：</span>
						<div class="member_body_input"><input type="text" name="company_jc" id="company_jc"  value="{$info.company_jc}" placeholder="公司简称"/></div>
						<div class="submit_error" id="company_jc_error">
							<div style="float:left;text-align:center;line-height:48px;"><img src="/static/common/img/error_icon.png" width="20" height="20"></div>
							<div style="float:left;">&nbsp;必填项</div>
						</div>
					</li>
					<li>
						<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;职位：</span>
						<div class="member_body_input"><input type="text" name="position" id="position"  value="{$info.position}" placeholder="职位"/></div>
						<div class="submit_error" id="position_error">
							<div style="float:left;text-align:center;line-height:48px;"><img src="/static/common/img/error_icon.png" width="20" height="20"></div>
							<div style="float:left;">&nbsp;必填项</div>
						</div>
					</li>
					<li>
						<span>&nbsp;&nbsp;&nbsp;&nbsp;公司名称：</span>
						<div class="member_body_input"><input type="text" name="company" id="company"  value="{$info.company}" placeholder="公司名称"/></div>
						<div class="submit_error" id="company_error">
							<div style="float:left;text-align:center;line-height:48px;"><img src="/static/common/img/error_icon.png" width="20" height="20"></div>
							<div style="float:left;">&nbsp;必填项</div>
						</div>
					</li>
				</ul>
				<input type="hidden" id="phone" value="{$info.userPhone}"/>
				<div class="input_error" id="edit_error" style="display:none;margin:30px 0 0 400px;"></div>
				<div class="login_submit" onclick="return editCheck()" style="margin:100px 0 0 400px;">提&nbsp;交</div>
			</div>
		</form>
	</div>
</body>
</html>
<script type="text/javascript">
	var w 	  = $(window).width();
	if(w>=1440){
		str_w = (1440-1200)/2;
		$(".member_body").css({"margin-left":str_w+"px"});  
	}
</script>
<script>

	/**
	 * 获取验证码
	 * @returns
	 */
	function getVerifyCode(){ 
		$("#userPhone_error").css('display','block'); 
		$("#imgcode_error").css('display','block'); 
		$("#edit_error").css('display','block'); 
		var phone	 = $("#editUserModal").find("input[name='userPhone']").val();
		var imgcode	 = $("#editUserModal").find("input[name='imgcode']").val();
		if(phone==""){
			$("#userPhone_error").css('display','block'); 
			return false;
		}
		if (!(/^1(3|4|5|6|7|8)\d{9}$/.test(phone))) {
	    	$("#userPhone_msg").html("&nbsp;请填写正确的手机号");
	    	$("#userPhone_error").css('display','block'); 
	        return false;
	    }
		if(imgcode==""){
			$("#imgcode_error").css('display','block'); 
			return false;
		}
			
		if ($("#sendCode").hasClass('verify_code_btn')) {
			$("#sendCode").removeClass("verify_code_btn");
			$("#sendCode").addClass("verify_code_btn_gray");
			$.ajax({
				url: "{:url('Member/getNewNumber')}",
	            type: 'POST',
	            dataType: 'json',
	            data: {"phone": phone,"imgcode":imgcode,"type": 1},
	            success: function(res){
	            	if (res.code == 200) {
	            		$("#userPhone_error").css('display','none'); 
	            		$("#userPhone_error").css('display','none'); 
	            		$("#imgcode_error").css('display','none'); 
	                    var i = 60;
	                    var it = setInterval(function(){
	                        if (i > 0) {
	                            $("#sendCode").html(i +" s");
	                        }else {
	                            $("#sendCode").removeClass("verify_code_btn_gray");
	                            $("#sendCode").addClass("verify_code_btn");
	                            $("#sendCode").html("获取验证码");
	                            clearInterval(it);
	                        }
	                        i--;
	                    }, 1000);
	                }else {
	                	$("#sendCode").removeClass("verify_code_btn_gray");
	        			$("#sendCode").addClass("verify_code_btn");
	                	$("#edit_error").html(res.msg);
	                	$("#edit_error").css('display','block'); 
	                }
	            }
	        })
		}
	}
	
	function editCheck(){ 
		$("#realName_error").css('display','none'); 
		$("#userPhone_error").css('display','none'); 
		$("#company_jc_error").css('display','none'); 
		$("#position_error").css('display','none'); 
		$("#company_error").css('display','none'); 
		$("#imgcode_error").css('display','none'); 
		$("#regcode_error").css('display','none'); 
		$("#edit_error").css('display','none'); 
		
		var realName	 = $("#editUserModal").find("input[name='realName']").val();
		var userPhone	 = $("#editUserModal").find("input[name='userPhone']").val();
		var company	 	 = $("#editUserModal").find("input[name='company']").val();
		var company_jc	 = $("#editUserModal").find("input[name='company_jc']").val();
		var position	 = $("#editUserModal").find("input[name='position']").val();
		var imgcode	 	 = $("#editUserModal").find("input[name='imgcode']").val();
		var regcode	 	 = $("#editUserModal").find("input[name='regcode']").val();
		var phone_org    = $("#phone").val();
	
		if(realName==""){
			$("#realName_error").css('display','block'); 
			return false;
		}
		if(userPhone==""){
			$("#userPhone_error").css('display','block'); 
			return false;
		}
		if(company_jc==""){
			$("#company_jc_error").css('display','block'); 
			return false;
		}
		if(position==""){
			$("#position_error").css('display','block'); 
			return false;
		}
		if(company==""){
			$("#company_error").css('display','block'); 
			return false;
		}
		
		if(userPhone != phone_org){
			if(imgcode==""){
				$("#imgcode_error").css('display','block'); 
				return false;
			}
			
			if(regcode==""){
				$("#regcode_error").css('display','block'); 
				return false;
			}
		}
		
		$.ajax({
	        url: "/home/member/doEdit",
	        type: 'POST',
	        dataType: 'json',
	        data: {"realName": realName,"userPhone": userPhone,"company": company,"company_jc": company_jc,"position": position,"imgcode": imgcode,"regcode": regcode},
	        success: function(res){
	        	console.log(res);
	        	if (res.code == 200) {
	        		window.location.href ="/home/member/index";
	            }else {
	            	$("#edit_error").html(res.msg);
	                $("#edit_error").css('display','block'); 
	            }
	        }
	    })
	}
	
	function keyup(){
		$("#userPhone_error").css('display','none'); 
		$("#regcode_error").css('display','none'); 
		var phone_org  = $("#phone").val();
		var phone_user = $("#userPhone").val();
		if(phone_user != phone_org){
			$("#sendCode").show();
			$("#verifycode").show();
			$("#imgage_code").show();
		}else{
			$("#sendCode").hide();
			$("#verifycode").hide();
			$("#imgage_code").hide();
		}
	}
	
	function editImg(){
		$("#compressFile").click(); //隐藏了input:file样式后，点击头像就可以本地上传
		$("#compressFile").on('change',function () {
	    	
	    	var fileSizeLimit   = 2048000;//图片最大size2M
	    	var fileTypeArray   = ['jpg','JPG','png','PNG','jpeg','JPEG'];
	    	
	    	$("#userPhoto_error").html('');
	    	$("#userPhoto_error").css("display","none");
	    	$("#edit_error").html('');
	    	$("#edit_error").css("display","none");
	        //文件改变时,获取文件,并转化为base64字符串
	        var file  	   = this.files[0]
	        var fileName   = file.name;
	        var fileType   = fileName.split(".")[1];//文件类型集合
	        var fileSize   = file.size;//文件大小限制
	        if(fileSize>fileSizeLimit){
	        	$("#userPhoto_error").html("文件超出了大小限制！请控制在2M以内！");
	            $("#userPhoto_error").css("display","block");
	            $("#edit_error").html("文件超出了大小限制！请控制在2M以内！");
	            $("#edit_error").css("display","block");
	            return false;
	        }
	        
	        if($.inArray(fileType, fileTypeArray)==-1){
	        	$("#userPhoto_error").html("图片类型不对！请上传后缀为jpg,png的文件！");
	            $("#userPhoto_error").css("display","block");
	            $("#edit_error").html("图片类型不对！请上传后缀为jpg,png的文件！");
	            $("#edit_error").css("display","block");
	            return false;
	        }
	        var ready = new FileReader()
	        ready.readAsDataURL(file);
	        ready.onload = function (e) {
	            var base64Img = e.target.result;
	            $("#compressFile").attr("src",base64Img)
	            $("#user_upload").css("background-image","url("+base64Img+")");
	            compress(base64Img)//执行压缩
	            $.ajax({
			        url: "/home/member/upImg",
			        type: 'POST',
			        dataType: 'json',
			        data: {"user_img": base64Img},
			        success: function(res){
			        	console.log(res);
			        	if (res.code == 200) {
			        		window.location.href ="/home/member/userInfo";
			            }else {
			            	$("#edit_error").html(res.msg);
			                $("#edit_error").css('display','block'); 
			            }
			        }
			    })
	        }
	        
	        
	    })
	}	
</script>



